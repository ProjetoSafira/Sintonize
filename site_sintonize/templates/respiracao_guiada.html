{% extends 'base.html' %}
{% load static %}

{% block title %}Respiração Guiada{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/respiracao.css' %}">

{% endblock %}

{% block content %}
<div class="secao-respiracao">
<div class="header-respiracao">
    <div class="header-content">
      <div class="texto-container">
        <h1>Respiração guiada</h1>
        <p>A respiração guiada é uma técnica que orienta o ritmo da respiração para promover relaxamento, reduzir o estresse e melhorar a concentração. Por meio de inspirações e expirações controladas, ativa o sistema nervoso parassimpático, trazendo equilíbrio e bem-estar.</p>
      </div>
      <div class="ilustracao-container">
        <img src="{% static 'images/respiracao/ilustracao-baixo.png' %}" alt="Ilustração de uma pessoa meditando" class="meditacao-img">
        <div class="circulo-respiracao">
          <img src="{% static 'images/respiracao/ilustracao-cima.png' %}" alt="Ícone demonstrativo de respiração" class="respiracao-icon">
        </div>
      </div>
    </div>
    <img src="{% static 'images/respiracao/curvas.png' %}" alt="" class="curvas-background" aria-hidden="true">
  </div>
</div>
  
<div class="secao-instrucoes">
    <div class="cabecalho-instrucoes">
        <h1>Acalme sua mente com a técnica de respiração 4-7-8</h1>
        <p>Com a prática, essa respiração se tornará sua aliada contra o estresse. Você poderá usá-la sempre que precisar: em casa, no trabalho ou até em público. Basta alguns minutos para trazer mais calma e equilíbrio ao seu dia. Abaixo, você encontrará um guia simples e prático para começar a técnica de respiração 4-7-8. Reserve esse momento para você, siga as instruções com tranquilidade e permita-se sentir os benefícios dessa prática transformadora.</p>
    </div>

    <div class="instrucoes-container">
        <div class="instrucoes-grid">
            <div class="instrucoes-lista-wrapper">
                <h2 class="instrucoes-titulo">Como praticar a respiração guiada</h2>
                <div class="instrucoes-lista">
                    <div class="instrucao-item">
                        <span class="instrucao-numero">1</span>
                        <span>Inspire suavemente pelo nariz por 4 segundos</span>
                    </div>
                    <div class="instrucao-item">
                        <span class="instrucao-numero">2</span>
                        <span>Segure nossos pulmões por 7 segundos</span>
                    </div>
                    <div class="instrucao-item">
                        <span class="instrucao-numero">3</span>
                        <span>Expire lentamente pela boca por 8 segundos</span>
                    </div>
                    <div class="instrucao-item">
                        <span class="instrucao-numero">4</span>
                        <span>Repita o ciclo e sinta seu corpo relaxar a cada respiração</span>
                    </div>
                </div>
            </div>
            <div class="contagem-tempo-wrapper">
                <h3 class="contagem-tempo-titulo">Contagem de Tempo</h3>
                <div class="contagem-tempo">
                    <div class="contagem-tempo-item">
                        <span class="tempo-label">Inspire</span> - <span class="tempo-valor">4 segundos</span>
                    </div>
                    <div class="contagem-tempo-item">
                        <span class="tempo-label">Segure</span> - <span class="tempo-valor">7 segundos</span>
                    </div>
                    <div class="contagem-tempo-item">
                        <span class="tempo-label">Expira</span> - <span class="tempo-valor">8 segundos</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="respiracao-container" role="main" aria-label="Exercício de respiração guiada">
  <svg xmlns="http://www.w3.org/2000/svg" width="1440px" height="674px" viewBox="0 0 1440 674" fill="none" class="background-svg" aria-hidden="true">
    <g filter="url(#filter0_dd_11836_5226)">
      <path d="M1440 18C1440 11.3726 1434.63 6 1428 6H10.9999C4.37256 6 -1 11.3726 -1 18V650C-1 656.627 4.37256 662 11 662H1428C1434.63 662 1440 656.627 1440 650V18Z" fill="url(#paint0_linear_11836_5226)" shape-rendering="crispEdges"/>
    </g>
    <defs>
      <filter id="filter0_dd_11836_5226" x="-9" y="0" width="1457" height="674" filterUnits="userSpaceOnUse" color-interpolation-filters="sRGB">
        <feFlood flood-opacity="0" result="BackgroundImageFix"/>
        <feColorMatrix in="SourceAlpha" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 127 0" result="hardAlpha"/>
        <feOffset dy="2"/>
        <feGaussianBlur stdDeviation="4"/>
        <feComposite in2="hardAlpha" operator="out"/>
        <feColorMatrix type="matrix" values="0 0 0 0 0 0 0 0 0 0.337255 0 0 0 0 0.8 0 0 0 0.06 0"/>
        <feBlend mode="normal" in2="BackgroundImageFix" result="effect1_dropShadow_11836_5226"/>
        <feColorMatrix in="SourceAlpha" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 127 0" result="hardAlpha"/>
        <feOffset dy="4"/>
        <feGaussianBlur stdDeviation="4"/>
        <feComposite in2="hardAlpha" operator="out"/>
        <feColorMatrix type="matrix" values="0 0 0 0 0.898039 0 0 0 0 0.905882 0 0 0 0 0.921569 0 0 0 0.08 0"/>
        <feBlend mode="normal" in2="effect1_dropShadow_11836_5226" result="effect2_dropShadow_11836_5226"/>
        <feBlend mode="normal" in="SourceGraphic" in2="effect2_dropShadow_11836_5226" result="shape"/>
      </filter>
      <linearGradient id="paint0_linear_11836_5226" x1="719.5" y1="6" x2="719.5" y2="662" gradientUnits="userSpaceOnUse">
        <stop stop-color="#FEFEFE"/>
        <stop offset="1" stop-color="#FAFAFA" stop-opacity="0.5"/>
      </linearGradient>
    </defs>
  </svg>

  <div class="animacao-container">
    <div class="circulo-container" aria-hidden="true">
      <svg viewBox="0 0 200 200" width="100%" height="100%">
        <circle cx="100" cy="100" r="80" class="circulo-inspire" />
        <circle cx="100" cy="100" r="80" class="circulo-segure" />
        <circle cx="100" cy="100" r="80" class="circulo-expira" />
      </svg>

      <div class="ponto-topo" aria-hidden="true">
        <svg xmlns="http://www.w3.org/2000/svg"  width="22.67"  height="22.579" viewBox="0 0 8 8" fill="none">
          <circle cx="4" cy="4" r="4" fill="#476970"/>
        </svg>
      </div>
      
      <button 
        class="texto-central" 
        id="texto-respiracao" 
        aria-live="assertive"
        tabindex="0"
        aria-label="Iniciar exercício de respiração">COMEÇAR</button>
    </div>
    
    <!-- Elemento invisível para leitores de tela -->
    <div class="sr-only" aria-live="polite" id="contador-tempo"></div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const pontoTopo = document.querySelector('.ponto-topo');
    const textoRespiracao = document.getElementById('texto-respiracao');
    const circuloContainer = document.querySelector('.circulo-container');
    const contadorTempo = document.getElementById('contador-tempo');
    let animacaoAtiva = false;
    let intervalo;
    let tentativasReconexao = 0;
    const maxTentativas = 3;

    // Adicionar elemento para mensagens de erro (invisível inicialmente)
    const mensagemErro = document.createElement('div');
    mensagemErro.className = 'mensagem-erro sr-only';
    mensagemErro.setAttribute('role', 'alert');
    mensagemErro.style.display = 'none';
    circuloContainer.appendChild(mensagemErro);

    function mostrarErro(mensagem) {
        mensagemErro.textContent = mensagem;
        mensagemErro.style.display = 'block';
        textoRespiracao.textContent = 'TENTAR NOVAMENTE';
        pararAnimacao();
    }

    function ocultarErro() {
        mensagemErro.style.display = 'none';
        mensagemErro.textContent = '';
    }

    function verificarPerformance() {
        return new Promise((resolve, reject) => {
            const inicioTeste = performance.now();
            
            // Simular uma operação para testar a performance
            requestAnimationFrame(() => {
                const tempoDecorrido = performance.now() - inicioTeste;
                if (tempoDecorrido > 100) { // Se demorar mais que 100ms
                    reject('Desempenho insuficiente para animação suave');
                } else {
                    resolve();
                }
            });
        });
    }

    async function iniciarAnimacao() {
        if (animacaoAtiva) return;

        try {
            ocultarErro();
            await verificarPerformance();

            animacaoAtiva = true;
            let tempoInicio = Date.now();
            let ultimaAtualizacao = tempoInicio;
            
            pontoTopo.classList.add('animando');
            circuloContainer.classList.add('animando');

            intervalo = setInterval(() => {
                const agora = Date.now();
                const tempoDecorrido = agora - tempoInicio;
                const tempoDesdeUltimaAtualizacao = agora - ultimaAtualizacao;

                // Verificar se houve atraso significativo entre atualizações
                if (tempoDesdeUltimaAtualizacao > 200) {
                    throw new Error('Instabilidade detectada na animação');
                }

                ultimaAtualizacao = agora;
                atualizarTexto(tempoDecorrido % 19000);
            }, 100);

        } catch (erro) {
            tentativasReconexao++;
            if (tentativasReconexao >= maxTentativas) {
                mostrarErro('Detectamos instabilidade na conexão. Por favor, verifique sua internet e tente novamente em alguns instantes.');
            } else {
                mostrarErro('Carregamento lento detectado. Tentando novamente...');
                setTimeout(() => {
                    if (animacaoAtiva) {
                        iniciarAnimacao();
                    }
                }, 2000);
            }
        }
    }

    function pararAnimacao() {
        animacaoAtiva = false;
        pontoTopo.classList.remove('animando');
        circuloContainer.classList.remove('animando');
        if (intervalo) {
            clearInterval(intervalo);
        }
        tentativasReconexao = 0;
    }

    function atualizarTexto(tempo) {
        try {
            if (tempo <= 4000) {
                textoRespiracao.textContent = 'INSPIRE';
                textoRespiracao.className = 'texto-central texto-inspire';
            } else if (tempo <= 11000) {
                textoRespiracao.textContent = 'SEGURE';
                textoRespiracao.className = 'texto-central texto-segure';
            } else {
                textoRespiracao.textContent = 'EXPIRE';
                textoRespiracao.className = 'texto-central texto-expira';
            }
        } catch (erro) {
            mostrarErro('Erro ao atualizar a animação. Tente novamente.');
            pararAnimacao();
        }
    }

    textoRespiracao.onclick = function() {
        if (animacaoAtiva) {
            pararAnimacao();
            textoRespiracao.textContent = 'COMEÇAR';
            textoRespiracao.className = 'texto-central';
        } else {
            iniciarAnimacao();
        }
    };

    // Função para reiniciar o exercício
    function reiniciarExercicio() {
        pararAnimacao();
        textoRespiracao.textContent = 'COMEÇAR';
        textoRespiracao.className = 'texto-central';
        ocultarErro();
    }

    // Adicionar evento de visibilidade
    document.addEventListener('visibilitychange', function() {
        if (document.hidden && animacaoAtiva) {
            reiniciarExercicio();
        }
    });

    // Adicionar evento para quando o usuário sair da página
    window.addEventListener('beforeunload', function() {
        reiniciarExercicio();
    });
});
</script>


{% endblock %}

